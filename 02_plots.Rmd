---
title: "R Notebook"
---

```{r}
library(tidyverse)
library(haven)
library(broom)
library(ggforce) 
library(survey)
library(marginaleffects)
library(scales)  
library(ggstats)
library(ggthemes)

source("01_process_data_script.R", local = knitr::knit_global())

```

```{r}
df <- process_qualtrics('data/CMC+Change.org_May+12,+2025_07.16.csv',
                        min_date = "2025-04-21")

prescreen <- read_csv('data/prescreen_data_20250512.csv', skip = 1)

print(prop.table(table(prescreen$Gender)) * 100)
print(prop.table(table(prescreen$Race)) * 100)
print(prop.table(table(prescreen$College)) * 100)
print(prop.table(table(prescreen$`Social Media`)) * 100)
```
## Descriptive Plots
Describe AI Primed category 
```{r}

## Prepare Likert data for Q13
df <- df %>% 
  rename(ai_is_appropriate = Q13,
         is_conservation_committed = Q14)

ai_likert <- df %>%
  group_by(AI_primed, ai_is_appropriate) %>%
  summarise(count = n(), .groups = "keep") %>%
  group_by(AI_primed) %>% 
  mutate(percentage = count / sum(count) * 100) %>%
  ungroup()

ai_likert <- ai_likert %>%
  mutate(
    ai_is_appropriate_broad = case_when(
      ai_is_appropriate == "Strongly disagree" ~ "Disagree", 
      ai_is_appropriate == "Somewhat disagree" ~ "Disagree",
      ai_is_appropriate == "Neither agree nor disagree" ~ "Neither agree nor disagree",
      ai_is_appropriate == "Somewhat agree" ~ "Agree",
      ai_is_appropriate == "Strongly agree" ~ "Agree",
      TRUE ~ NA
    )
  )

ai_likert$ai_is_appropriate_broad <- factor(ai_likert$ai_is_appropriate_broad,
                              levels = c("Disagree",
                                         "Neither agree nor disagree",
                                         "Agree"))

ai_likert$AI_primed <- factor(ai_likert$AI_primed,
                              levels = c(0,1),
                              labels = c("Control", "AI-Primed"))

gglikert(ai_likert,
         include = ai_is_appropriate_broad,
         facet_rows = vars(AI_primed),
         symmetric = TRUE,
         add_totals = FALSE) +
  ggtitle("It is appropriate to use AI when writing a petition.") +
  theme_minimal() + 
    theme(
    axis.text.y = element_blank())

```
Marignal means
```{r}
df_mm <- df
df_mm$long_petition <- factor(df_mm$long_petition,
                           levels = c(0,1),
                           labels = c("Short", "Long"))
df_mm$good_title <- factor(df_mm$good_title,
                        levels = c(0,1),
                        labels = c("Bad","Good"))


ai_mm <- bind_rows(
  tidy(lm(selected_petition ~ 0 + good_title, data = df_mm %>% filter(AI_primed == 1)),
       conf.int = TRUE),
  tidy(lm(selected_petition ~ 0 + long_petition, data = df_mm %>% filter(AI_primed == 1)),
       conf.int = TRUE))
ai_mm <- ai_mm %>%
  mutate(
    petition_attribute = case_when(
    term %in% c("good_titleBad", "good_titleGood") ~ "title quality",
    term %in% c("long_petitionShort", "long_petitionLong") ~ "petition length"
  ),
  attribute_value = case_when(
    term == "good_titleBad" ~ "Bad Title",
    term == "good_titleGood" ~ "Good Title",
    term == "long_petitionShort" ~ "Short Petition",
    term == "long_petitionLong" ~ "Long Petition"
  )
  )

control_mm <- bind_rows(
  tidy(lm(selected_petition ~ 0 + good_title, data = df_mm %>% filter(AI_primed == 0)),
       conf.int = TRUE),
  tidy(lm(selected_petition ~ 0 + long_petition, data = df_mm %>% filter(AI_primed == 0)),
       conf.int = TRUE))

control_mm <- control_mm %>% 
  mutate(
    petition_attribute = case_when(
    term %in% c("good_titleBad", "good_titleGood") ~ "Title Quality",
    term %in% c("long_petitionShort", "long_petitionLong") ~ "Petition Length"
  ),
  attribute_value = case_when(
    term == "good_titleBad" ~ "Bad Title",
    term == "good_titleGood" ~ "Good Title",
    term == "long_petitionShort" ~ "Short Petition",
    term == "long_petitionLong" ~ "Long Petition"
  ))

ai_mm_plot <- ai_mm %>%
  ggplot(aes(x = estimate, y = attribute_value, color = petition_attribute)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  geom_vline(xintercept = 0, color = "grey", linetype = 2) + 
  scale_x_continuous(labels = label_comma()) +
  labs(
    x = "Marginal Mean", y = NULL, 
    title = "Treatment Group"
  ) + 
  guides(color = guide_legend(title = "Petition Attribute"))

control_mm_plot <- control_mm %>%
  ggplot(aes(x = estimate, y = attribute_value, color = petition_attribute)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  geom_vline(xintercept = 0, color = "grey", linetype = 2) + 
  scale_x_continuous(labels = label_comma()) +
  labs(
    x = "Marginal Mean", y = NULL, 
    title = "Control Group"
  ) + 
  guides(color = guide_legend(title = "Petition Attribute"))

ai_mm_plot 
control_mm_plot
```

## Causal Plots
```{r}
df %>% 
  summarize(pass_attention = mean(pass_attention),
            per_AI_primed = mean(AI_primed))
```


```{r}
df_model_overall <- lm(selected_petition ~ long_petition + good_title, data = df)
tidy(df_model_overall)

df_model <- lm(selected_petition ~ long_petition + good_title, data = df %>% 
                 filter(AI_primed==0))
tidy(df_model)

df_model_AI <- lm(selected_petition ~ long_petition + good_title, data = df %>% 
                    filter(AI_primed==1))
tidy(df_model_AI)

df %>% 
  group_by(AI_primed, long_petition) %>% 
  summarize(avg = mean(selected_petition, na.rm = T))

df %>% 
  group_by(AI_primed, good_title) %>% 
  summarize(avg = mean(selected_petition, na.rm = T))

bind_rows(
  bind_rows(
  tidy(lm(selected_petition ~ 0 + long_petition, data = filter(df, AI_primed==1))),
  tidy(lm(selected_petition ~ 0 + good_title, data = filter(df, AI_primed==1)))
) %>% 
  mutate(type = "AI_primed"),

bind_rows(
  tidy(lm(selected_petition ~ 0 + long_petition, data = filter(df, AI_primed==0))),
  tidy(lm(selected_petition ~ 0 + good_title, data = filter(df, AI_primed==0)))
) %>% 
  mutate(type = "No AI priming")
)
```

```{r}
df_model %>%
  tidy_and_attach()
```
```{r}
df_model <- df_model %>%
  tidy_and_attach() %>% 
  tidy_add_reference_rows() %>%
  tidy_add_estimate_to_reference_rows() %>%
  filter(term != "(Intercept)")

df_model$term <- factor(df_model$term,
                         levels = c("long_petition", "good_title"),
                         labels = c("Petition Length", "Title Quality"))

amce_plot <- ggplot(df_model, aes(x = estimate, y = term, colour = term)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  geom_vline(xintercept = 0, color = "grey", linetype = 2) + 
  labs(
    x = "Estimated AMCE", y = NULL
  ) + 
  guides(color = guide_legend(title = "Petition Attribute")) + 
  theme_classic()

amce_plot
```
```{r}
model_logit <- glm(
  selected_petition ~ long_petition + good_title, data = df %>% filter(AI_primed==1,
                                                                       !is.na(selected_petition)),
  family = binomial(link = "logit")
)

mfx_logit <- model_logit %>% 
  avg_slopes()

mfx_logit
```
```{r}
rhs_vars <- all.vars(stats::update(formula(model_logit), 0 ~ .))

model_variable_levels <- tibble(
  variable = rhs_vars
) %>% 
  mutate(levels = map(variable, ~{
    x <- df[[.x]]
    if (is.numeric(x)) {
      as.character(unique(x))
    } else if (is.factor(x)) {
      levels(x)
    } else {
      sort(unique(x))
    }
  })) %>% 
  unnest(levels) %>% 
  mutate(term = paste0(variable, levels))

label_pp <- label_number(accuracy = 1, scale = 100, 
                         suffix = " pp.", style_negative = "minus")

label_amce <- label_number(accuracy = 0.1, scale = 100, suffix = " pp.", 
                           style_negative = "minus", style_positive = "plus")

```
```{r}
model_results_logit_mfx <- mfx_logit %>%
  separate_wider_delim(
    contrast,
    delim = " - ", 
    names = c("variable_level", "reference_level")
  )

variable_lookup <- tribble(
  ~variable,    ~variable_nice,
  "good_title", "Good title",
  "long_petition", "Long petition",
) %>% 
  mutate(variable_nice = fct_inorder(variable_nice))

# Combine full dataset of factor levels with marginal effects
plot_data_logit_mfx <- model_variable_levels %>%
  left_join(
    model_results_logit_mfx,
    by = join_by(variable == term, levels == variable_level)
  ) %>%
  # Make these zero
  mutate(
    across(
      c(estimate, conf.low, conf.high),
      ~ ifelse(is.na(.x), 0, .x)
    )
  ) %>% 
  left_join(variable_lookup, by = join_by(variable)) %>% 
  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))

plot_data_logit_mfx
```

```{r}
ggplot(
  plot_data_logit_mfx,
  aes(x = estimate, y = levels, color = variable_nice)
) +
  geom_vline(xintercept = 0) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  scale_x_continuous(labels = label_pp) +
  guides(color = "none") +
  labs(
    x = "Percentage point change in probability of petition selection",
    y = NULL,
    title = "AMCEs from logistic regression marginal effects"
  ) +
  facet_col(facets = "variable_nice", scales = "free", space = "free")
```



