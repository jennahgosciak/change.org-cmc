---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(haven)
library(broom)
library(ggforce) 
library(survey)
library(marginaleffects)
library(scales)  

source("01_process_data_script.R", local = knitr::knit_global())

```

```{r}
df <- process_qualtrics('data/export_labels_20250502.csv')

prescreen <- read_csv('data/prescreen_data_20250502.csv', skip = 1)

print(prop.table(table(prescreen$Gender)) * 100)
print(prop.table(table(prescreen$Race)) * 100)
print(prop.table(table(prescreen$College)) * 100)
print(prop.table(table(prescreen$`Social Media`)) * 100)
```

```{r}
df %>% 
  summarize(pass_attention = mean(pass_attention),
            per_AI_primed = mean(AI_primed))
```
```{r}
df_model_overall <- lm(selected_petition ~ long_petition + good_title, data = df)
tidy(df_model_overall)

df_model <- lm(selected_petition ~ long_petition + good_title, data = df %>% 
                 filter(AI_primed==0))
tidy(df_model)

df_model_AI <- lm(selected_petition ~ long_petition + good_title, data = df %>% 
                    filter(AI_primed==1))
tidy(df_model_AI)

df %>% 
  group_by(AI_primed, long_petition) %>% 
  summarize(avg = mean(selected_petition, na.rm = T))

df %>% 
  group_by(AI_primed, good_title) %>% 
  summarize(avg = mean(selected_petition, na.rm = T))

bind_rows(
  bind_rows(
  tidy(lm(selected_petition ~ 0 + long_petition, data = filter(df, AI_primed==1))),
  tidy(lm(selected_petition ~ 0 + good_title, data = filter(df, AI_primed==1)))
) %>% 
  mutate(type = "AI_primed"),

bind_rows(
  tidy(lm(selected_petition ~ 0 + long_petition, data = filter(df, AI_primed==0))),
  tidy(lm(selected_petition ~ 0 + good_title, data = filter(df, AI_primed==0)))
) %>% 
  mutate(type = "No AI priming")
)
```

```{r}
df_model %>%
  tidy_and_attach()
```
```{r}
df_model %>%
  tidy_and_attach() %>% 
  tidy_add_reference_rows() %>%
  tidy_add_estimate_to_reference_rows() %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(x = estimate, y = term)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  labs(
    x = "Estimate", y = NULL,
    title = "Relative shift in average",
    subtitle = "Similar to AMCEs"
  ) +
  theme_classic()
```
```{r}
model_logit <- glm(
  selected_petition ~ long_petition + good_title, data = df %>% filter(AI_primed==1,
                                                                       !is.na(selected_petition)),
  family = binomial(link = "logit")
)

mfx_logit <- model_logit %>% 
  avg_slopes()

mfx_logit
```
```{r}
rhs_vars <- all.vars(stats::update(formula(model_logit), 0 ~ .))

model_variable_levels <- tibble(
  variable = rhs_vars
) %>% 
  mutate(levels = map(variable, ~{
    x <- df[[.x]]
    if (is.numeric(x)) {
      as.character(unique(x))
    } else if (is.factor(x)) {
      levels(x)
    } else {
      sort(unique(x))
    }
  })) %>% 
  unnest(levels) %>% 
  mutate(term = paste0(variable, levels))

label_pp <- label_number(accuracy = 1, scale = 100, 
                         suffix = " pp.", style_negative = "minus")

label_amce <- label_number(accuracy = 0.1, scale = 100, suffix = " pp.", 
                           style_negative = "minus", style_positive = "plus")

```
```{r}
model_results_logit_mfx <- mfx_logit %>%
  separate_wider_delim(
    contrast,
    delim = " - ", 
    names = c("variable_level", "reference_level")
  )

variable_lookup <- tribble(
  ~variable,    ~variable_nice,
  "good_title", "Good title",
  "long_petition", "Long petition",
) %>% 
  mutate(variable_nice = fct_inorder(variable_nice))

# Combine full dataset of factor levels with marginal effects
plot_data_logit_mfx <- model_variable_levels %>%
  left_join(
    model_results_logit_mfx,
    by = join_by(variable == term, levels == variable_level)
  ) %>%
  # Make these zero
  mutate(
    across(
      c(estimate, conf.low, conf.high),
      ~ ifelse(is.na(.x), 0, .x)
    )
  ) %>% 
  left_join(variable_lookup, by = join_by(variable)) %>% 
  mutate(across(c(levels, variable_nice), ~fct_inorder(.)))

plot_data_logit_mfx
```

```{r}
ggplot(
  plot_data_logit_mfx,
  aes(x = estimate, y = levels, color = variable_nice)
) +
  geom_vline(xintercept = 0) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  scale_x_continuous(labels = label_pp) +
  guides(color = "none") +
  labs(
    x = "Percentage point change in probability of petition selection",
    y = NULL,
    title = "AMCEs from logistic regression marginal effects"
  ) +
  facet_col(facets = "variable_nice", scales = "free", space = "free")
```



